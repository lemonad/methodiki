{% extends "base-without-sidebar.html" %}
{% load i18n markup markitup_tags taggit_extras thumbnail %}

{% block css %}
  {% markitup_css %}
  <link href="/media/javascript/fileuploader/fileuploader.css"
        rel="stylesheet" type="text/css" />
  <link href="/media/javascript/jquery-taggit/jquery.taggit.css"
        rel="stylesheet" type="text/css" />
  <link href="/media/javascript/jquery.fancybox-1.3.4/jquery.fancybox-1.3.4.css"
        rel="stylesheet" type="text/css" />
{% endblock %}

{% block javascript %}
  {% markitup_js "no-jquery" %}
  <script type="text/javascript" src="/media/javascript/jquery.timers-1.2.js"></script>
  <script type="text/javascript" src="/media/javascript/jquery-taggit/jquery.taggit.js"></script>
  <script type="text/javascript" src="/media/javascript/jquery.fancybox-1.3.4/jquery.fancybox-1.3.4.pack.js"></script>
  <script type="text/javascript">
    $(document).ready(function() {
      var suggested_tags = [
          {% for tag in suggested_tags %}
          "{{ tag }}",
          {% endfor %}
        ];
      taggit = $("#id_method-tags").taggit({suggested_tags: suggested_tags,
                                            suggested_tags_id: "suggested-tags"});

      var uploader = new qq.FileUploader({
          element: document.getElementById('file-uploader'),
          action: '{% url methods-upload-file method.slug %}',
          data: {
              csrfmiddlewaretoken : "{{ csrf_token }}",
          },
          template: '<div class="qq-uploader">' + 
                    '<div class="qq-upload-drop-area"><span>{% trans "Drop files here to upload" %}</span></div>' +
                    '<div class="qq-upload-button rounded-3">{% trans "Upload an image" %}</div>' +
                    '<ul class="qq-upload-list"></ul>' + 
                    '</div>',
          onComplete: function(id, fileName, responseJSON) {
            var link_and_image = "<li><a class=\"method-image\" href=\"";
            if (responseJSON.width > 600 || responseJSON.height > 500) {
                link_and_image += "http://{{ request.META.HTTP_HOST }}" +
                                  responseJSON.url;
            } else {
                link_and_image += "http://{{ request.META.HTTP_HOST }}" +
                                  responseJSON.original_url;
            }
            link_and_image += "\"><img src=\"" + responseJSON.thumbnail_url +
                              "\" /></a></li>";
            $("#uploaded-media-list").append(link_and_image);
            $(".method-image").click(function() {
                $.markItUp({ replaceWith: '![{% trans "Alternative text" %}](' +
                                          this.href +
                                          ' "{% trans "Title" %}")' });
                return false;
            });
            $("#uploaded-media").show("slow");
          }
      });
      $(".method-image, a.image-add").click(function() {
          $.markItUp({replaceWith: this.href});
          return false;
      });
      $("a.image-delete").click(function() {
          if (!confirm("{% trans "Delete image?" %}")) {
              return false;
          }
          var id_str = this.id + "";
          var match = id_str.match(/^delete-image-([0-9]+)/);
          if (match) {
              var image_id = match[1];
              $.ajax({
                  type: "POST",
                  url: "{% url methods-delete-file method.slug %}",
                  data: {"xhr": 1, "deleteimage": image_id},
                  dataType: "json",
                  timeout: 10000,
                  success: function(data, textStatus) {
                      $("#image-" + image_id).hide();
                      return true;
                  },
                  error: function(xhr, textStatus, errorThrown) {
                      if (xhr.status !== 304) {
                          alert("fail!");
                      }
                  }
              });
          }
          return false;
      });
      $("#uploaded-media li").hover(function() {
          $(this).children(".image-preview,.image-delete,.image-add").show();
      }, function() {
          $(this).children(".image-preview,.image-delete,.image-add").hide();
      });
      $("a.image-preview").fancybox({"hideOnContentClick": true,
                                     "margin": 14});
      $("#preview img").each(function() {
          $(this).fancybox({"hideOnContentClick": true,
                            "type": "image",
                            "href": this.src,
                            "margin": 14});
      });
      $("h3.options").click(function() {
          $(this).next().toggle();
          return false;
      });
    });
  </script>
{% endblock %}

{% block main %}
  {% include "methods-preview.html" %}

  <div class="method span-18 prepend-3 append-3 last">
    <h2>{% trans "Edit away!" %}</h2>
    {% include "methods-markdown-quick-help.html" %}
  </div>

  <div class="method span-18 prepend-3 append-3 last">
  <div class="column box rounded-9">
    <form id="method-form" method="post"
          action="{% url methods-edit-method method.slug %}">
      {% csrf_token %}
      <div class="span-18 last">
        {{ form.title.label_tag }}
      </div>
      <div class="span-18 last">
        {{ form.title }}
      </div>
      {% if form.title.errors %}
      <p>
        {{ form.title.errors }}
      </p>
      {% endif %}

      <div class="span-18 last">
        {{ form.description.label_tag }}
      </div>
      <div class="span-18 last">
        {{ form.description }}
      </div>
      {% if form.description.errors %}
      <p>
        {{ form.description.errors }}
      </p>
      {% endif %}

      <div id="uploaded-media" class="span-18 last" style="margin-top:0.5em;">
        <ul id="uploaded-media-list">
        {% for image in images %}
        <li id="image-{{ image.id }}" class="rounded-6"
            style="position:relative;left:0;top:0;display:inline-block;">
          <a class="method-image" href="{{ image.image.url }}">
            <img class="rounded-3" src="{% thumbnail image.image 50x50 %}"
                 title="{{ image.image.size }}"/>
          </a>
          <a class="image-add" href="{{ image.image.url }}"
             style="display:none;">
            <img class="image-add"
                 src="/media/images/icons/001_01.png"
                 title="{% trans "Add image to text" %}"
                 style="display:block;position:absolute;bottom:24px;left:17px;" />
          </a>
          <a class="image-preview" href="{{ image.image.url }}"
             style="display:none;">
            <img class="image-preview"
                 src="/media/images/icons/001_37.png"
                 title="{% trans "Preview" %}"
                 style="display:block;position:absolute;bottom:0px;left:0px;"/>
          </a>
          <a id="delete-image-{{ image.id }}" class="image-delete"
             href="#" style="display:none;">
            <img class="image-delete"
                 src="/media/images/icons/001_05.png"
                 title="{% trans "Delete image" %}"
                 style="display:block;position:absolute;bottom:0px;right:0px;" />
          </a>
        </li>
        {% endfor %}
        </ul>
        {% comment %}
        <p>{% blocktrans %}
          Hover over an image and click the plus sign to add the image
          where you've placed the cursor in the text.
        {% endblocktrans %}</p>
        {% endcomment %}
      </div>

      <div id="file-uploader" class="span-18 last">
        <noscript>
          <p>Please enable JavaScript to use file uploader.</p>
          <!-- or put a simple form for upload here -->
        </noscript>
      </div>

      <h2>{% trans "Optional settings" %}</h2>
      <h3 class="span-18 last options rounded-6">
        {% trans "Tags" %}
      </h3>
      <div class="span-18 last" style="display:none;">
        <div class="span-18 last">
          {{ form.tags }}
        </div>
        {% if form.tags.errors %}
        <p>
          {{ form.tags.errors }}
        </p>
        {% endif %}

        <div class="span-18 last tagInputSuggestedTags">
          <span class="label">{% trans "Suggested tags:" %}</span>
          <span id="suggested-tags" class="tagInputSuggestedTagList"></span>
        </div>
      </div>

      <div class="span-18 last" style="text-align: right;margin-bottom:1em;">
        <input class="submit" type="submit" name="preview"
               value="{% trans "Preview" %}" />
        <input class="submit" type="submit" name="method"
               value="{% trans "Save" %}" />
      </div>
    </form>

    <hr />
    {% include "methods-meta.html" %}

    {% ifequal method.status "DRAFT" %}
    <form style="display:inline;" method="post"
          action="{% url methods-edit-method method.slug %}">
      {% csrf_token %}
      <input class="submit" type="submit" name="publish"
             value="{% trans "Publish method" %}" />
    </form>
    {% endifequal %}

    {% ifequal method.status "PUBLISHED" %}
    <form style="display:inline;" method="post"
          action="{% url methods-edit-method method.slug %}">
      {% csrf_token %}
      <input class="submit" type="submit" name="unpublish"
             value="{% trans "Unpublish method" %}" />
    </form>
    {% endifequal %}

    <form style="display:inline;" method="post"
          action="{% url methods-edit-method method.slug %}">
      {% csrf_token %}
      <input class="submit" type="submit" name="delete"
             value="{% trans "Delete method" %}" />
    </form>
  </div>
  </div>

  <script src="/media/javascript/fileuploader/fileuploader.js"
          type="text/javascript"></script>
{% endblock %}
